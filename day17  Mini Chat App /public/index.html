<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mini Chat App</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Configure Tailwind to use class-based dark mode
      tailwind.config = {
        darkMode: "class",
      };
    </script>

    <!-- Poppins Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
      /* Custom CSS Variables for Theming */
      :root {
        /* Light Mode Defaults */
        --primary: #4f46e5;
        --bg-body: #f3f4f6;
        --text-color: #1f2937;
      }

      html.dark {
        /* Dark Mode Overrides */
        --primary: #818cf8; /* Indigo 400 for contrast */
        --bg-body: #111827; /* Gray 900 */
        --text-color: #f3f4f6;
      }

      body {
        font-family: "Poppins", sans-serif;
        background-color: var(--bg-body);
        color: var(--text-color);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem;
        transition: background-color 0.3s ease; /* Smooth theme switch */
      }

      /* Focus Glow for Input */
      input:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.4);
      }

      /* Chat Window Styling */
      #messages {
        list-style: none;
        padding: 0;
        margin: 0;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--primary) transparent;
        scroll-behavior: smooth;
      }

      #messages::-webkit-scrollbar {
        width: 8px;
      }

      #messages::-webkit-scrollbar-thumb {
        background-color: var(--primary);
        border-radius: 4px;
      }

      #messages::-webkit-scrollbar-track {
        background: transparent;
      }

      /* Message Fade-in Animation */
      .message-item {
        opacity: 0;
        animation: fadeIn 0.4s ease-out forwards;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body class="transition-colors duration-300">
    <!-- Main Chat Container -->
    <div
      id="chat-container"
      class="w-full max-w-3xl bg-white dark:bg-gray-800 shadow-2xl rounded-2xl flex flex-col h-[90vh] md:h-[80vh] overflow-hidden border border-gray-100 dark:border-gray-700 transition-colors duration-300"
    >
      <!-- Chat Header -->
      <header
        class="p-4 bg-indigo-600 dark:bg-indigo-700 text-white flex justify-between items-center sticky top-0 z-10 shadow-md transition-colors duration-300"
      >
        <h1 class="text-xl font-bold tracking-wide">
          <i
            data-lucide="message-square"
            class="inline-block h-6 w-6 mr-2 -mt-1"
          ></i>
          Kejela Chat Room
        </h1>
        <div class="flex items-center space-x-3">
          <span
            id="user-display"
            class="text-sm font-medium bg-white dark:bg-gray-100 text-indigo-600 dark:text-indigo-800 px-3 py-1 rounded-full shadow-inner transition-colors duration-300"
          ></span>

          <!-- Theme Toggle Button -->
          <button
            id="theme-toggle"
            class="p-2 rounded-full bg-indigo-500 hover:bg-indigo-400 dark:bg-gray-600 dark:hover:bg-gray-500 transition duration-300"
            title="Toggle Dark/Light Mode"
          >
            <i data-lucide="sun" class="h-5 w-5 text-white" id="theme-icon"></i>
          </button>
        </div>
      </header>

      <!-- Messages Display Area -->
      <ul id="messages" class="flex-grow p-5 space-y-5">
        <!-- Messages will be appended here -->
      </ul>

      <!-- Message Input Area (Sticky Footer) -->
      <form
        id="form"
        class="p-4 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600 sticky bottom-0 z-10 flex space-x-3 transition-colors duration-300"
      >
        <input
          id="input"
          autocomplete="off"
          class="flex-grow p-3 border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-xl focus:border-indigo-600 transition duration-300 text-gray-700"
          placeholder="Send a message..."
        />
        <button
          type="submit"
          class="bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white font-semibold py-3 px-5 rounded-xl shadow-lg transition duration-300 transform hover:scale-[1.02]"
          title="Send Message"
        >
          <i data-lucide="send" class="h-6 w-6"></i>
        </button>
      </form>
    </div>

    <!-- Socket.io Client CDN -->
    <script src="/socket.io/socket.io.js"></script>

    <script>
      // CLIENT-SIDE JAVASCRIPT LOGIC

      const htmlEl = document.documentElement;
      const themeToggle = document.getElementById("theme-toggle");
      const themeIcon = document.getElementById("theme-icon");

      // --- Theme Functions ---

      const updateThemeIcon = (isDark) => {
        themeIcon.setAttribute("data-lucide", isDark ? "moon" : "sun");
        lucide.createIcons();
      };

      const applyInitialTheme = () => {
        const storedTheme = localStorage.getItem("theme");
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;

        let isDark = false;
        if (storedTheme === "dark") {
          isDark = true;
        } else if (storedTheme === null && prefersDark) {
          isDark = true;
        }

        if (isDark) {
          htmlEl.classList.add("dark");
        }
        updateThemeIcon(isDark);
      };

      const toggleTheme = () => {
        const isDark = htmlEl.classList.toggle("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        updateThemeIcon(isDark);
      };

      // Apply theme on initial load
      applyInitialTheme();

      // Listen for theme toggle click
      themeToggle.addEventListener("click", toggleTheme);

      // --- Chat Logic ---

      // Initialize Lucide Icons (must run after theme icon update)
      document.addEventListener("DOMContentLoaded", () => {
        lucide.createIcons();
      });

      const socket = io();
      const form = document.getElementById("form");
      const input = document.getElementById("input");
      const messages = document.getElementById("messages");
      const userDisplay = document.getElementById("user-display");
      let username = "";

      // Simple hashing for consistent user colors
      const getUserColor = (user) => {
        let hash = 0;
        for (let i = 0; i < user.length; i++) {
          hash = user.charCodeAt(i) + ((hash << 5) - hash);
        }
        const colorIndex = Math.abs(hash) % 8; // Use 8 distinct colors
        const colors = [
          "bg-red-400",
          "bg-green-400",
          "bg-blue-400",
          "bg-yellow-400",
          "bg-purple-400",
          "bg-pink-400",
          "bg-teal-400",
          "bg-orange-400",
        ];
        return colors[colorIndex];
      };

      // --- Utility Functions ---

      const scrollToBottom = () => {
        messages.scrollTop = messages.scrollHeight;
      };

      const appendMessage = (data, isNotification = false) => {
        const item = document.createElement("li");
        item.classList.add("message-item");

        if (isNotification) {
          // User Joined/Left Notification
          item.className =
            "text-center text-xs font-medium text-gray-500 dark:text-gray-400 py-2 message-item transition-colors duration-300";
          item.textContent = data;
        } else {
          // Determine if the message is from the current user
          const isSelf = data.id === socket.id;
          const userColor = getUserColor(data.user);
          const userInitial = data.user.charAt(0).toUpperCase();

          item.classList.add("flex", isSelf ? "justify-end" : "justify-start");

          item.innerHTML = `
                    <div class="flex items-end space-x-2 max-w-xs md:max-w-md ${
                      isSelf ? "flex-row-reverse space-x-reverse" : ""
                    }">
                        
                        <!-- Avatar (only for others) -->
                        ${
                          !isSelf
                            ? `
                            <div class="flex-shrink-0 w-8 h-8 rounded-full shadow-md text-white font-bold text-sm flex items-center justify-center ${userColor}">
                                ${userInitial}
                            </div>
                        `
                            : ""
                        }

                        <!-- Message Content -->
                        <div>
                            <div class="text-[0.7rem] font-medium ${
                              isSelf
                                ? "text-right text-gray-400 dark:text-gray-500"
                                : "text-left text-gray-600 dark:text-gray-300"
                            } mb-1 transition-colors duration-300">
                                ${isSelf ? "You" : data.user}
                            </div>
                            <div class="p-3 shadow-lg rounded-xl transition duration-200 ease-in-out 
                                ${
                                  isSelf
                                    ? "bg-indigo-600 text-white rounded-br-sm"
                                    : "bg-gray-100 dark:bg-gray-600 text-gray-800 dark:text-gray-100 rounded-tl-sm border border-gray-200 dark:border-gray-500"
                                }">
                                ${data.text}
                            </div>
                            <div class="text-xs text-gray-400 mt-1 ${
                              isSelf ? "text-right" : "text-left"
                            } transition-colors duration-300">
                                ${data.timestamp}
                            </div>
                        </div>
                    </div>
                `;
        }

        messages.appendChild(item);
        scrollToBottom();
      };

      // --- User Initialization ---

      const generateRandomName = () =>
        `User${Math.floor(Math.random() * 1000)}`;

      const initUser = () => {
        let inputUsername = prompt("Welcome! Please enter your chat username:");
        if (!inputUsername || inputUsername.trim() === "") {
          username = generateRandomName();
        } else {
          username = inputUsername.trim().substring(0, 20);
        }

        userDisplay.textContent = `Online as: ${username}`;
        socket.emit("set user", username);
      };

      // Initialize user immediately
      initUser();

      // --- Event Listeners ---

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const messageText = input.value.trim();
        if (messageText) {
          socket.emit("chat message", messageText);
          input.value = "";
          input.blur();
        }
      });

      socket.on("chat message", (data) => {
        appendMessage(data);
      });

      socket.on("chat notification", (notification) => {
        appendMessage(notification, true);
      });
    </script>
  </body>
</html>
